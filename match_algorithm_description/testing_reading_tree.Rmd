---
title: "Test reading tree"
author: "Bruno Crotman"
date: "01/05/2020"
output: pdf_document
---

```{r setup, include=FALSE}

library(tidyverse)
library(xml2)
library(tidygraph)
library(ggraph)

source("functions.r", encoding = "UTF-8") 


knitr::opts_chunk$set(echo = TRUE)

```

## Introduction 

This is a test, I'm trying to read the abstract syntax tree of a code using PMD rules

```{r}

shell(r"(C:\doutorado\AnaliseTwitter4j\pmd\bin/pmd.bamat -d C:\doutorado\AnaliseTwitter4j\match_algorithm_description\new -f xml -R C:\doutorado\AnaliseTwitter4j\match_algorithm_description\blockrules\blockrules.xml -reportfile C:\doutorado\AnaliseTwitter4j\match_algorithm_description\oldblock.xml)")


```
    

## Introduction 



```{r}

alerts <- read_pmd_xml("oldblock.xml")  

max_column <- max(alerts$endcolumn)

alerts_from <- alerts %>%  rename_all(.funs = ~str_glue("{.x}_from"))

alerts_to <- alerts %>%  rename_all(.funs = ~str_glue("{.x}_to"))

edges <- alerts_from %>% 
    crossing(alerts_to) %>% 
    mutate(
        location_begin_from = beginline_from * max_column + begincolumn_from,
        location_begin_to = beginline_to * max_column + begincolumn_to,
        location_end_from = endline_from * max_column + endcolumn_from,
        location_end_to = endline_to * max_column + endcolumn_to
    ) %>% 
    filter(id_alert_from != id_alert_to) %>% 
    filter(
        location_begin_from <= location_begin_to & location_end_from >= location_end_to
    ) %>% 
    select(
        from = id_alert_from,
        to =id_alert_to
    ) 
    

complete_graph <- create_empty(n = 0, directed = TRUE) %>% 
    bind_nodes(alerts) %>% 
    bind_edges(edges) 


graph_dfs_tree <- complete_graph %>% 
    convert(to_dfs_tree, root = 1, mode = "out" )
    

edges <- graph_dfs_tree %>% 
    activate(edges)



    
```




```{r}

nos <- tibble(no = c(1, 2, 3 ,4, 5 ))


grafo <- create_empty(0) %>% 
    bind_nodes(nos) %>% 
    bind_edges(
        
        tribble(
            ~from,  ~to,
            1,      2,
            1,      3,
            1,      4,
            2,      4,
            1,      5,
            4,      5,
            2,      5
        )
        
        
    )


ggraph(grafo) +
    geom_edge_link() +
    geom_node_text(aes(label = no))


arvore <- grafo %>% 
    convert(to_dfs_tree, root = 1, mode = "out" )

ggraph(arvore, layout = "kk") +
    geom_edge_link() +
    geom_node_text(aes(label = no))



arvore %>% 
    activate(edges)


```








